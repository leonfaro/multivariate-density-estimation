---
title: "TRTF and TTM Pseudocode"
author: "Research Team"
date: "2025-08-13"
output: html_document
---

## Notation & Setup

Let $\pi(x)$ denote the target log density and $\eta(z)$ the base log density. The triangular transport map $S: \mathbb{R}^K \to \mathbb{R}^K$ has components $S_k(x_1,\ldots,x_k)$ for $k=1,\ldots,K$. Here $N$ is the number of observations and $K$ the dimension of $x$. The change of variables states, in words, that the log density of $x$ under $\pi$ equals the log density of $S(x)$ under $\eta$ plus the log determinant of the Jacobian, which reduces to a sum of log partial derivatives because $S$ is triangular. The pipeline main() -> TRUE/TRTF/KS/TTM marginal governs all experiments. Model artifacts are TRTF and the Marginal Map (diagonal). All log densities are measured in nats, and sums over dimensions yield the joint log density.

## TRTF Pseudocode
### fit\_TRTF($S$, seed)

1. Set the global `seed`.
2. Let $X$ be the $N\times K$ sample matrix.
3. Define `ymod` by fitting a marginal BoxCox model for $X_1$.
4. For $k=2,\ldots,K$:
   - Fit a transformation forest for $X_k$ with predictors $(X_1,\ldots,X_{k-1})$.
   - Store the fitted forest, variable importance and configuration.
5. Output an object containing `ymod`, the list of forests, `seed` and the configuration.

### predict(TRTF, $X$, type)

1. Compute $ld1$, the log density of the first dimension via `ymod`.
2. For $j=1,\ldots,K-1$:
   - Compute conditional log densities for column $j+1$ using forest $j$ with predictors $(X_1,\ldots,X_j)$.
   - Take the diagonal of the resulting prediction matrix.
3. Form $ll = \text{cbind}(ld1, \text{conditional contributions})$.
4. Ensure $ll$ contains no NA or $\infty$ entries.
5. If `type == 'logdensity_by_dim'` return $ll$ (an $N\times K$ matrix).
6. Else return $\text{rowSums}(ll)$, labelled `'logdensity'`.
7. Summing over $K$ dimensions yields the joint log density.
8. Damit gilt: `logdensity_by_dim` ist $N\times K$ und $\text{rowSums}(ll) =`'logdensity'`.

## Marginal Map Pseudocode

1. Input $\{x_i\}_{i=1}^N$.
2. For each dimension $k$:
   - Fit a univariate map $S_k$ on $x_k$.
   - Accumulate $\log \partial_{x_k} S_k(x_k)$.
3. Evaluate $\log \eta(S(x))$ using the diagonal map.
4. Return $\log \pi(x)$ as the sum of base log density and accumulated terms.

## Acceptance & Reproducibility

A model is accepted when its joint log density exceeds that of the baseline. All computations use a single global seed shared across models. This policy ensures reproducibility and comparability across TRTF and Marginal Map (diagonal) artifacts.

